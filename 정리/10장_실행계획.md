# 10장. 실행 계획

대부분의 DBMS는 많은 데이터를 안전하게 저장 및 관리하고 사용자가 원하는 데이터를 **빠르게** 조회할 수 있게 해주는 것이 주목적이다. 이러한 목적을 달성하려면 옵티마이저가 사용자의 쿼리를 최적으로 처리될 수 있게 하는 쿼리의 실행 계획을 수립할 수 있어야 한다.

하지만 옵티마이저가 관리자나 사용자의 개입 없이 항상 좋은 실행 계획을 만들어낼 수 있는 것은 아니다. DBMS 서버는 이러한 문제점을 관리자나 사용자가 보완할 수 있도록 `EXPLAIN` 명령으로 옵티마이저가 수립한 실행 계획을 확인할 수 있게 해준다.

## 통계 정보

MySQL 서버는 5.7 버전까지 테이블과 인덱스에 대한 개괄적인 정보를 가지고 실행 계획을 수립했다.
: `테이블 칼럼의 값들의 분포에 대한 정보가 없기 때문에 실행 계획에 대한 정확도가 떨어짐!`

### 테이블 및 인덱스 통계 정보

비용 기반 최적화에서 가장 중요한 것은 통계 정보이다. 통계 정보가 정확하지 않다면 전혀 엉뚱한 방향으로 쿼리를 실행할 수 있기 때문이다. 예를 들어, 1억 건의 레코드가 저장된 테이블의 통계 정보가 갱신되지 않아서 레코드가 10건 미만인 것처럼 돼 있다면 옵티마이저는 인덱스 레인지 스캔이 아닌, 풀 테이블 스캔으로 실행해 버릴 수도 있다. : `왜냐면, 인덱스를 읽어온 뒤 다시 테이블을 읽는 것보다, 한번에 테이블에서 데이터를 가져올 수 있다고 생각하므로!`

MySQL 또한 다른 DBMS와 같이 비용 기반의 최적화를 사용하지만, 다른 DBMS보다 통계 정확도가 높지 않고, 휘발성이 강했다. 그래서 MySQL 서버에서는 쿼리의 실행 계획을 수립할 때 실제 테이블의 데이터를 일부 분석해서 통계 정보를 보완해서 사용했다. : `실제 데이터를 분석하는데에 오버헤드가 있을 것 같은데..!`

#### MySQL 서버의 통계 정보

MySQL 5.6 버전부터는 InnoDB 스토리지 엔진을 사용하는 테이블에 대한 통계 정보를 영구적으로 관리할 수 있게 개선됐다. : `이전 버전에서는 메모리에 통계 정보를 수집해왔다고 한다. (휘발성)`

MySQL 5.6 버전부터는 각 테이블의 통계 정보를 테이블로 관리할 수 있게 개선되었다. : `innodb_index_stats` , `innodb_table_stats`

MySQL 5.5 버전까지는 테이블의 통계 정보가 메모리에만 저장되며, MySQL 서버가 재시작되면 통계 정보가 초기화됐다. 그래서 MySQL 서버가 시작되면 모든 테이블의 통계 정보는 다시 수집돼야 했다.

영구적인 통계 정보를 사용한다면 MySQL 서버의 점검이나 사용량이 많지 않은 시간을 이용해 더 정확한 통계 정보를 수집할 수도 있다. 물론 더 정확한 통계 정보 수집에는 많은 시간이 소요되겠지만, 이 **통계 정보의 정확성에 의해 쿼리의 성능이 결정되기 때문에 시간을 투자할 충분한 가치가 있는 것**이다.

### 히스토그램

MySQL 5.7 버전까지의 통계 정보는 단순히 인덱스된 칼럼의 유니크한 값의 개수 정도만 가지고 있었는데, 이는 옵티마이저가 최적의 실행 계획을 수립하기에는 많이 부족했다. : `이를 보완하기 위해, 실행 계획을 수립할 때 실제 인덱스의 일부 페이지를 랜덤으로 가져와 참조하는 방식을 사용!`

8.0 버전으로 업그레이드되면서 MySQL 서버도 드디어 **칼럼의 데이터 분포도**를 참조할 수 있는 히스토그램(Histogram) 정보를 활용할 수 있게 됐다.

#### 히스토그램 정보 수집 및 삭제

MySQL 8.0 버전에서 히스토그램 정보는 칼럼 단위로 관리되는데, 이는 자동으로 수집되지 않고 수동으로 수집 및 관리된다.

```sql
-- 히스토그램 정보 수집
ANALYZE TABLE employees.employees
UPDATE HISTOGRAM ON gender, hire_date;

-- 조회
SELECT *
FROM COLUMN_STATISTICS
WHERE SCHEMA_NAME = 'employees' AND TABLE_NAME = 'employees'
```

**히스토그램 타입 종류**

- **싱글톤 히스토그램** : 칼럼값 개별로 레코드 건수를 관리하는 히스토그램으로, Value-Based 히스토그램 또는 도수 분포라고 불린다.
- **높이 균형 히스토그램** : 칼럼값의 범위를 균등한 개수로 구분해서 관리하는 히스토그램으로, Height-Balanced 히스토그램이라고도 불린다. : 기울기가 일정하다는 것의 의미는 데이터가 고른 범위에 분포되어있다는 의미이다.

#### 히스토그램 용도

MySQL 서버에 히스토그램이 도입되기 이전에도 테이블과 인덱스에 대한 통계 정보는 존재했다. 하지만 기존 MySQL 서버가 가지고 있던 통계 정보는 **테이블의 전체 레코드 건수와 인덱스된 칼럼이 가지는 유니크한 값의 개수** 정도이다.

Ex. 테이블의 레코드가 1000건이고, 유니크한 값 개수가 100개 였다면, MySQL 서버는 이 칼럼에 대해 다음과 같은 동등 비교 검색을 하면 대략 10개의 레코드가 일치할 것이라고 예측한다. : `그렇다면, 데이터가 충분히 많으니 인덱스를 타고 검색을 했겠지?`

히스토그램 정보가 없으면 옵티마이저는 데이터가 균등하게 분포돼 있을 것으로 예측하지만, 히스토그램이 있으면 특정 범위의 데이터가 많고 적음을 식별할 수 있다. : `이는 조인과 같이 기준이 되는 테이블을 선택할 때, 큰 도움을 줄 것으로 생각된다!`

#### 히스토그램과 인덱스

히스토그램과 인덱스는 완전히 다른 객체이기 때문에 서로 비교할 대상은 아니지만, MySQL 서버에서 인덱스는 부족한 통계 정보를 수집하기 위해 사용된다는 측면에서 어느 정도 공통점을 가진다고 볼 수 있다.
